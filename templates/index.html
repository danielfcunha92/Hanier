<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>Gráficos de Tingimento</title>
  <style>
    body {
      font-family: Tahoma, sans-serif;
      background-color: #e8ecf0;
      margin: 0;
      padding: 20px;
    }
    .container {
      background-color: #f4f4f4;
      padding: 15px 25px;
      border-radius: 5px;
      max-width: 1000px;
      margin: auto;
      box-shadow: 0 0 8px rgba(0,0,0,0.1);
    }
    h2 {
      font-size: 20px;
      margin-bottom: 10px;
    }
    button {
      background-color: #ececec;
      border: 1px solid #999;
      padding: 6px 12px;
      font-size: 13px;
      margin: 3px 2px;
      cursor: pointer;
    }
    button:hover {
      background-color: #ddd;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      background-color: white;
      margin-top: 10px;
    }
    th, td {
      border: 1px solid #aaa;
      padding: 6px;
      text-align: center;
    }
    th {
      background-color: #dce6f2;
      font-weight: bold;
    }
    p {
      margin-top: 20px;
      font-weight: bold;
      text-align: center;
    }
    #modal {
      display: none;
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.6);
      justify-content: center;
      align-items: center;
    }
    #modal-content {
      background: white;
      padding: 20px;
      border-radius: 8px;
      min-width: 400px;
    }
    #modal select, #modal input {
      margin-bottom: 10px;
      width: 100%;
      padding: 6px;
    }
  </style>
</head>
<body>
<div class="container">
  <img src="{{ url_for('static', filename='logo_hanier.png') }}" alt="Logo Hanier" style="float: right; width: 160px; margin-top: -10px; margin-right: 10px;">
  <h2>Gráficos de Tingimento</h2>
  <div style="margin-bottom: 15px;">
    <button onclick="abrirModal()">Nova Etapa</button>
    <!-- Outros botões -->
  </div>
  <table>
    <tr><th>Tipo de Etapa</th><th>Resumo</th><th>Tempo (min)</th></tr>
    {% for etapa in etapas %}
    <tr>
      <td>{{ etapa.tipo }}</td>
      <td>{{ etapa.dados.get('resumo', '') }}</td>
      <td>{{ etapa.dados.get('tempo', '') }}</td>
    </tr>
    {% endfor %}
  </table>
  <p>Tempo total: {{ tempo_total }}</p>
  <h3>Gráfico de Temperatura × Tempo</h3>
  <img src="/grafico.png?{{ tempo_total }}" width="800" alt="Gráfico de Tingimento">
</div>

<div id="modal">
  <div id="modal-content">
    <h3>Nova Etapa</h3>
    <label for="tipo">Tipo de Etapa:</label>
    <select id="tipo">
      <option value="Encher Máquina">Encher Máquina</option>
      <option value="Injetar Produto">Injetar Produto</option>
      <option value="Dosagem de Produto">Dosagem de Produto</option>
      <option value="Termoregulação">Termoregulação</option>
      <option value="Patamar">Patamar</option>
      <option value="Transbordo">Transbordo</option>
      <option value="Soltar Banho">Soltar Banho</option>
      <option value="Aviso">Aviso</option>
    </select>
    <button onclick="confirmarEtapa()">Confirmar</button>
    <button onclick="fecharModal()">Cancelar</button>
  </div>
</div>

<script>
function abrirModal() {
  document.getElementById('modal').style.display = 'flex';
}
function fecharModal() {
  document.getElementById('modal').style.display = 'none';
}
async function confirmarEtapa() {
  const tipo = document.getElementById('tipo').value;
  let dados = {}, tempo = 0, temperatura = 0, resumo = "";

  if (tipo === 'Encher Máquina') {
    const agua = prompt("Água quente ou fria?");
    const relacao = prompt("Relação de banho (1:x)?");
    tempo = 3;
    temperatura = (agua.toLowerCase().includes("quente")) ? 40 : 25;
    resumo = `Água ${agua}, 1:${relacao}`;
    dados = { resumo, tempo, temperatura };
  }
  else if (tipo === 'Injetar Produto') {
    const produto = prompt("Nome do produto?");
    const agua = prompt("Água limpa ou retorno?");
    tempo = 1;
    temperatura = 0;
    resumo = `${produto} com água ${agua}`;
    dados = { resumo, tempo, temperatura };
  }
  else if (tipo === 'Dosagem de Produto') {
    const produto = prompt("Produto?");
    const tempo_dosagem = prompt("Tempo de dosagem (min)?");
    const curva = prompt("Curva?");
    tempo = parseFloat(tempo_dosagem);
    temperatura = 0;
    resumo = `${produto}, curva ${curva}`;
    dados = { resumo, tempo, temperatura };
  }
  else if (tipo === 'Termoregulação') {
    const t1 = parseFloat(prompt("Temperatura inicial?"));
    const t2 = parseFloat(prompt("Temperatura final?"));
    const grad = parseFloat(prompt("Gradiente °C/min?"));
    tempo = Math.abs(t2 - t1) / grad;
    temperatura = t2;
    resumo = `${t1} → ${t2}°C a ${grad}°C/min`;
    dados = { resumo, tempo, temperatura };
  }
  else if (tipo === 'Patamar') {
    temperatura = parseFloat(prompt("Temperatura (°C)?"));
    tempo = parseFloat(prompt("Tempo (min)?"));
    resumo = `${temperatura}°C por ${tempo} min`;
    dados = { resumo, tempo, temperatura };
  }
  else if (tipo === 'Transbordo') {
    const t1 = parseFloat(prompt("Temp. inicial?"));
    const t2 = parseFloat(prompt("Temp. final?"));
    tempo = parseFloat(prompt("Tempo (min)?"));
    const relacao = prompt("Relação de banho (1:x)?");
    temperatura = t2;
    resumo = `${t1} → ${t2}°C em ${tempo} min, 1:${relacao}`;
    dados = { resumo, tempo, temperatura };
  }
  else if (tipo === 'Soltar Banho') {
    tempo = 2;
    temperatura = 0;
    resumo = `Descarga do banho`;
    dados = { resumo, tempo, temperatura };
  }
  else if (tipo === 'Aviso') {
    const aviso = prompt("Qual aviso? (Amostra / Medir pH / Medir densidade)");
    let faixa = "";
    if (aviso.toLowerCase().includes("ph")) faixa = prompt("Faixa de pH?");
    resumo = aviso + (faixa ? ` (${faixa})` : "");
    tempo = 0;
    temperatura = 0;
    dados = { resumo, tempo, temperatura };
  }

  await fetch("/adicionar_etapa", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ tipo, dados })
  });
  fecharModal();
  location.reload();
}
</script>

</body>
</html>

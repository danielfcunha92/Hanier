<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>Gráficos de Tingimento</title>
  <style>
    body {
      font-family: Tahoma, sans-serif;
      background-color: #e8ecf0;
      margin: 0;
      padding: 20px;
    }
    .container {
      background-color: #f4f4f4;
      padding: 15px 25px;
      border-radius: 5px;
      max-width: 1000px;
      margin: auto;
      box-shadow: 0 0 8px rgba(0,0,0,0.1);
    }
    h2 {
      font-size: 20px;
      margin-bottom: 10px;
    }
    button {
      background-color: #ececec;
      border: 1px solid #999;
      padding: 6px 12px;
      font-size: 13px;
      margin: 3px 2px;
      cursor: pointer;
    }
    button:hover {
      background-color: #ddd;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      background-color: white;
      margin-top: 10px;
    }
    th, td {
      border: 1px solid #aaa;
      padding: 6px;
      text-align: center;
    }
    th {
      background-color: #dce6f2;
      font-weight: bold;
    }
    p {
      margin-top: 20px;
      font-weight: bold;
      text-align: center;
    }
    #modal {
      display: none;
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.6);
      justify-content: center;
      align-items: center;
    }
    #modal-content {
      background: white;
      padding: 20px;
      border-radius: 8px;
      min-width: 400px;
    }
    #modal select, #modal input {
      margin-bottom: 10px;
      width: 100%;
      padding: 6px;
    }
  </style>
</head>
<body>
<div class="container">
  <img src="{{ url_for('static', filename='logo_hanier.png') }}" alt="Logo Hanier" style="float: right; width: 160px; margin-top: -10px; margin-right: 10px;">
  <h2>Gráficos de Tingimento</h2>
  <div style="margin-bottom: 15px;">
    <button onclick="abrirModal()">Nova Etapa</button>
    <button onclick="editarEtapa()">Editar Etapa</button>
    <button onclick="excluirEtapa()">Excluir Etapa</button>
    <button onclick="subirEtapa()">↑ Subir</button>
    <button onclick="descerEtapa()">↓ Descer</button>
    <button onclick="limparEtapas()">Limpar</button>
    <button onclick="editarTitulo()">Editar Título</button>
    <button onclick="salvarEtapas()">Salvar Etapas</button>
    <button onclick="carregarEtapas()">Carregar Etapas</button>
    <button onclick="imprimir(false)">Imprimir</button>
    <button onclick="imprimir(true)">Receita</button>
  </div>
  <table>
    <tr><th>Tipo de Etapa</th><th>Resumo</th><th>Tempo (min)</th></tr>
    {% for etapa in etapas %}
    <tr>
      <td>{{ etapa.tipo }}</td>
      <td>{{ etapa.dados.get('resumo', '') }}</td>
      <td>{{ etapa.dados.get('tempo', '') }}</td>
    </tr>
    {% endfor %}
  </table>
  <p>Tempo total: {{ tempo_total }}</p>
  <h3>Gráfico de Temperatura × Tempo</h3>
  <button onclick="gerarGrafico()">Gerar gráfico</button>
  <br><br>
  <img id="grafico" src="" width="800" alt="Gráfico de Tingimento" style="display:none;">

</div>
<div id="modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); justify-content:center; align-items:center;">
  <div style="background:white; padding:20px; border-radius:8px; width:300px;">
    <h3>Nova Etapa</h3>
    <label for="tipo">Tipo de Etapa:</label>
    <select id="tipo" onchange="mostrarCamposEtapa()">
<option value="Encher Máquina">Encher Máquina</option>
<option value="Injetar Produto">Injetar Produto</option>
<option value="Termorregulação">Termorregulação</option>


    </select>
    <div id="campos-etapa"></div>
    <button onclick="confirmarEtapa()">Confirmar</button>
    <button onclick="fecharModal()">Cancelar</button>
  </div>
</div>


<script>
function abrirModal() {
  document.getElementById("modal").style.display = "flex";
  mostrarCamposEtapa();  // <- Isso garante que os campos apareçam
}


function fecharModal() {
  document.getElementById("modal").style.display = "none";
}

function mostrarCamposEtapa() {
  const tipo = document.getElementById("tipo").value;
  const campos = document.getElementById("campos-etapa");
  campos.innerHTML = "";

  if (tipo === "Encher Máquina") {
    campos.innerHTML += `
      <label>Água:</label>
      <select id="agua">
        <option value="Quente">Quente</option>
        <option value="Fria">Fria</option>
      </select>
      <label>Relação de Banho (1:x):</label>
      <input id="relacao" type="number" placeholder="Ex: 10">
    `;
  }

  if (tipo === "Injetar Produto") {
    campos.innerHTML += `
      <label>Produto:</label>
      <input id="produto" type="text" placeholder="Nome do produto">
      <label>Água:</label>
      <select id="agua_inj">
        <option value="Limpa">Limpa</option>
        <option value="Retorno">Retorno</option>
      </select>
    `;
  }
   if (tipo === "Termorregulação") {
    campos.innerHTML += `
      <label>Temp. atual (°C):</label>
      <input id="temp_atual" type="number" placeholder="Ex: 60">
      <label>Temp. final (°C):</label>
      <input id="temp_final" type="number" placeholder="Ex: 90">
      <label>Gradiente (°C/min):</label>
      <input id="gradiente" type="number" placeholder="Ex: 3">
  `  ;
  }

}


async function confirmarEtapa() {
  const tipo = document.getElementById("tipo").value;
  let dados = {}, tempo = 3, temperatura = 0, resumo = "";

  if (tipo === "Encher Máquina") {
    const agua = document.getElementById("agua").value;
    const relacao = document.getElementById("relacao").value;
    temperatura = agua === "Quente" ? 40 : 25;
    resumo = `Água ${agua}, 1:${relacao}`;
    dados = { resumo, tempo, temperatura };
  }

  else if (tipo === "Injetar Produto") {
    const produto = document.getElementById("produto").value;
    const agua = document.getElementById("agua_inj").value;
    tempo = 2;

    try {
      const linhas = document.querySelectorAll("table tr");
      if (linhas.length > 2) {
        const ultima = linhas[linhas.length - 2]; // ignora cabeçalho
        const tipoEtapa = ultima.cells[0].textContent;
        const resumoEtapa = ultima.cells[1].textContent;

        // 1. Tenta extrair a última temperatura informada (ex: "60°C")
        const regex = /(\d+)°C/g;
        const temperaturas = [...resumoEtapa.matchAll(regex)];

        if (temperaturas.length > 0) {
          const ultimaTemp = temperaturas[temperaturas.length - 1];
          temperatura = parseFloat(ultimaTemp[1]);
        }
        // 2. Se não tiver °C, tenta deduzir a partir de "Encher Máquina"
        else if (tipoEtapa === "Encher Máquina") {
          if (resumoEtapa.includes("Quente")) temperatura = 40;
          else if (resumoEtapa.includes("Fria")) temperatura = 25;
        }
        // 3. Se ainda não definiu temperatura, tenta recuperar da célula de tempo anterior
        if (!temperatura || temperatura === 0) {
          const tempStr = ultima.cells[2].textContent;
          temperatura = parseFloat(tempStr) || 25;  // fallback final
        }
      }
    } catch (e) {
      console.error("Erro ao recuperar temperatura anterior:", e);
      temperatura = 25;  // fallback total
    }

    resumo = `${produto} com água ${agua}`;
    dados = { resumo, tempo, temperatura };
  }


  else if (tipo === "Termorregulação") {
    const tempInicial = parseFloat(document.getElementById("temp_atual").value);
    const tempFinal = parseFloat(document.getElementById("temp_final").value);
    let gradiente = parseFloat(document.getElementById("gradiente").value);
    if (!gradiente || gradiente <= 0) gradiente = 5; // se 0 ou inválido, usa 5
    const diferenca = Math.abs(tempFinal - tempInicial);
    tempo = diferenca / gradiente;


    const acao = tempFinal > tempInicial ? "Aquecer" : "Resfriar";
    resumo = `${acao} de ${tempInicial}°C até ${tempFinal}°C, ${gradiente}°C/min`;


    dados = {
      resumo,
      tempo: Math.round(tempo),
      temperatura: tempFinal
    };
  }

  await fetch("/adicionar_etapa", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ tipo, dados })
  });

  fecharModal();
  location.reload();
}

function gerarGrafico() {
  const img = document.getElementById("grafico");
  img.src = "/grafico.png?" + new Date().getTime(); // força atualização
  img.style.display = "block";
}
</script>

</body>
</html>

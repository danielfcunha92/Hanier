<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>{{ titulo }}</title>
  <style>
    body { font-family: Tahoma, sans-serif; background-color: #e8ecf0; margin: 0; padding: 20px; }
    .container { background-color: #f4f4f4; padding: 15px 25px; border-radius: 5px; max-width: 1000px; margin: auto; box-shadow: 0 0 8px rgba(0,0,0,0.1); }
    h2 { font-size: 20px; margin-bottom: 10px; }
    button { background-color: #ececec; border: 1px solid #999; padding: 6px 12px; font-size: 13px; margin: 3px 2px; cursor: pointer; }
    button:hover { background-color: #ddd; }
    table { width: 100%; border-collapse: collapse; background-color: white; margin-top: 10px; }
    th, td { border: 1px solid #aaa; padding: 6px; text-align: center; }
    th { background-color: #dce6f2; font-weight: bold; }
    p { margin-top: 20px; font-weight: bold; text-align: center; }
    tr.selected { background-color: #fff2a8; }
    #modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); justify-content: center; align-items: center; }
    #modal-content { background: white; padding: 20px; border-radius: 8px; min-width: 400px; }
    #modal select, #modal input { margin-bottom: 10px; width: 100%; padding: 6px; }
  </style>
</head>
<body>
  <div class="container">
    <img src="{{ url_for('static', filename='logo_hanier.png') }}" alt="Logo Hanier"
         style="float: right; width: 160px; margin-top: -10px; margin-right: 10px;">
    <h2>{{ titulo }}</h2>
    <div style="margin-bottom: 15px;">
      <button id="btnNova">Nova Etapa</button>
      <button id="btnEditar">Editar Etapa</button>
      <button id="btnExcluir">Excluir Etapa</button>
      <button id="btnSubir">↑ Subir</button>
      <button id="btnDescer">↓ Descer</button>
      <button id="btnLimpar">Limpar</button>
      <button id="btnTitulo">Editar Título</button>
      <button id="btnSalvar">Salvar Etapas</button>
      <button id="btnCarregar">Carregar Etapas</button>
      <button id="btnImprimir">Imprimir</button>
      <button id="btnReceita">Receita</button>
    </div>
    <table id="tabela-etapas">
      <tr><th>Tipo de Etapa</th><th>Resumo</th><th>Tempo (min)</th></tr>
      {% for etapa in etapas %}
      <tr data-index="{{ loop.index0 }}">
        <td>{{ etapa.tipo }}</td>
        <td>{{ etapa.dados.resumo }}</td>
        <td>{{ etapa.dados.tempo }}</td>
      </tr>
      {% endfor %}
    </table>
    <p>Tempo total: {{ tempo_total }}</p>
    <h3>Gráfico de Temperatura × Tempo</h3>
    <button id="btnGrafico">Gerar Gráfico</button>
    <img id="grafico" src="" style="display:none; width:800px; margin-top:10px;" alt="Gráfico de Tingimento">
  </div>

  <div id="modal">
    <div id="modal-content">
      <h3>Nova Etapa</h3>
      <label>Tipo de Etapa:</label>
      <select id="tipo"></select>
      <div id="campos-etapa"></div>
      <button id="btnConfirmar">Confirmar</button>
      <button id="btnFechar">Cancelar</button>
    </div>
  </div>

  <input type="file" id="fileInput" accept=".json" style="display:none">

  <script>
    const etapasData = {{ etapas_json | safe }};
    const fileInput = document.getElementById('fileInput');
    let selectedIndex = null;

    document.addEventListener('DOMContentLoaded', () => {
      // referências
      const btnNova    = document.getElementById('btnNova');
      const btnEditar  = document.getElementById('btnEditar');
      const btnExcluir = document.getElementById('btnExcluir');
      const btnSubir   = document.getElementById('btnSubir');
      const btnDescer  = document.getElementById('btnDescer');
      const btnLimpar  = document.getElementById('btnLimpar');
      const btnTitulo  = document.getElementById('btnTitulo');
      const btnSalvar  = document.getElementById('btnSalvar');
      const btnCarregar= document.getElementById('btnCarregar');
      const btnImprimir= document.getElementById('btnImprimir');
      const btnReceita = document.getElementById('btnReceita');
      const btnGrafico = document.getElementById('btnGrafico');
      const tipoSelect = document.getElementById('tipo');
      const btnConfirmar = document.getElementById('btnConfirmar');
      const btnFechar    = document.getElementById('btnFechar');
      const tabela       = document.getElementById('tabela-etapas');

      // eventos
      btnNova.addEventListener('click', abrirModal);
      btnConfirmar.addEventListener('click', confirmarEtapa);
      btnFechar.addEventListener('click', fecharModal);
      tipoSelect.addEventListener('change', mostrarCamposEtapa);
      btnGrafico.addEventListener('click', gerarGrafico);
      btnEditar.addEventListener('click', editarEtapa);
      btnExcluir.addEventListener('click', excluirEtapa);
      btnSubir.addEventListener('click', subirEtapa);
      btnDescer.addEventListener('click', descerEtapa);
      btnLimpar.addEventListener('click', limparEtapas);
      btnTitulo.addEventListener('click', editarTitulo);
      btnSalvar.addEventListener('click', salvarEtapas);
      btnCarregar.addEventListener('click', () => fileInput.click());
      btnImprimir.addEventListener('click', () => imprimir(false));
      btnReceita.addEventListener('click', () => imprimir(true));
      fileInput.addEventListener('change', uploadDados);

      tabela.querySelectorAll('tr[data-index]')
            .forEach(tr => tr.addEventListener('click', selecionarLinha));
    });

    function selecionarLinha(evt) {
      document.querySelectorAll('#tabela-etapas tr.selected')
              .forEach(r => r.classList.remove('selected'));
      const tr = evt.currentTarget;
      tr.classList.add('selected');
      selectedIndex = +tr.dataset.index;
    }

    function abrirModal() {
      const tipos = [
        'Encher Máquina','Injetar Produto','Dosagem de Produto',
        'Termoregulação','Patamar','Transbordo','Soltar Banho','Aviso'
      ];
      document.getElementById('tipo').innerHTML =
        tipos.map(t => `<option value="${t}">${t}</option>`).join('');
      document.getElementById('modal').style.display = 'flex';
      mostrarCamposEtapa();
    }

    function fecharModal() {
      document.getElementById('modal').style.display = 'none';
    }

    function mostrarCamposEtapa() {
      const tipo = document.getElementById('tipo').value;
      const campos = document.getElementById('campos-etapa');
      let html = '';
      switch (tipo) {
        case 'Encher Máquina':
          html = `
            <label>Água:</label>
            <select id="agua"><option>Quente</option><option>Fria</option></select>
            <label>Relação de Banho (1:x):</label>
            <input id="relacao" type="number" placeholder="Ex: 10">
          `;
          break;
        case 'Injetar Produto':
          html = `
            <label>Produto:</label>
            <input id="produto" type="text" placeholder="Nome do produto">
            <label>Água:</label>
            <select id="agua_inj"><option>Limpa</option><option>Retorno</option></select>
          `;
          break;
        case 'Dosagem de Produto':
          html = `
            <label>Sequência do Produto:</label>
            <input id="sequencia" type="text" placeholder="Ex: A">
            <label>Tempo de Dosagem (min):</label>
            <input id="tempo_dos" type="number" placeholder="Ex: 5">
            <label>Curva (opcional):</label>
            <input id="curva_dos" type="text" placeholder="Ex: rampa">
          `;
          break;
        case 'Termoregulação':
          html = `
            <label>Temp. atual (°C):</label><input id="temp_atual" type="number">
            <label>Temp. final (°C):</label><input id="temp_final" type="number">
            <label>Gradiente (°C/min):</label><input id="gradiente" type="number" placeholder="Ex: 3">
          `;
          break;
        case 'Patamar':
          html = `
            <label>Temperatura (°C):</label><input id="temp_pat" type="number">
            <label>Tempo (min):</label><input id="tempo_pat" type="number">
          `;
          break;
        case 'Transbordo':
          html = `
            <label>Relação (1:x):</label><input id="rt_val" type="number">
            <label>Temp. Inicial (°C):</label><input id="ti" type="number">
            <label>Temp. Final (°C):</label><input id="tf" type="number">
            <label>Tempo (min):</label><input id="tempo_tr" type="number">
          `;
          break;
        case 'Soltar Banho':
          html = `<p>Soltar Banho</p>`;
          break;
        case 'Aviso':
          html = `
            <label>Aviso:</label>
            <select id="aviso"><option>Amostra</option><option>Medir Densidade</option><option>Medir pH</option></select>
            <div id="ph-campos"></div>
          `;
          break;
      }
      campos.innerHTML = html;
      const aviso = document.getElementById('aviso');
      if (aviso) aviso.onchange = e => {
        document.getElementById('ph-campos').innerHTML =
          e.target.value==='Medir pH'
          ? '<label>Faixa de pH:</label><input id="faixa_ph" type="text">'
          : '';
      };
    }

    // UNIFICADA: sempre lê direto de etapasData
    function lastStepTemp() {
      if (!etapasData || etapasData.length===0) return 0;
      const last = etapasData[etapasData.length-1];
      return last.dados && last.dados.temperatura!=null
        ? Number(last.dados.temperatura)
        : 0;
    }

    async function confirmarEtapa() {
      const tipo = document.getElementById('tipo').value;
      let tempo=0, temperatura=0, resumo='';
      switch(tipo) {
        case 'Encher Máquina': {
          const agua = document.getElementById('agua').value;
          const rel  = document.getElementById('relacao').value;
          tempo=3; temperatura = agua==='Quente'?40:25;
          resumo = `Água ${agua}, 1:${rel}`;
          break;
        }
        case 'Injetar Produto': {
          const prod    = document.getElementById('produto').value;
          const aguaInj = document.getElementById('agua_inj').value;
          tempo=2; temperatura = lastStepTemp();
          resumo = `${prod}, água ${aguaInj}`;
          break;
        }
        case 'Dosagem de Produto': {
          const seq   = document.getElementById('sequencia').value || '';
          const td    = parseFloat(document.getElementById('tempo_dos').value)||0;
          const curva = document.getElementById('curva_dos').value;
          tempo       = td;
          temperatura = lastStepTemp();
          resumo      = `Seq ${seq}, Dosagem: ${td} min${curva?`, curva ${curva}`:''}`;
          break;
        }
        case 'Termoregulação': {
          const t0        = parseFloat(document.getElementById('temp_atual').value) || 0;
          const t1        = parseFloat(document.getElementById('temp_final').value) || 0;
          const gradInput = parseFloat(document.getElementById('gradiente').value);
          // se digitou 0 ou deixou em branco, usa 5°C/min para o cálculo
          const gCalc     = (gradInput === 0 || isNaN(gradInput)) ? 5 : gradInput;
          tempo            = Math.abs(t1 - t0) / gCalc;
          temperatura      = t1;
          // mas no resumo mostramos o valor original (até 0)
          resumo           = `${t1>t0?'Aquecer':'Resfriar'} de ${t0}→${t1}°C, ${gradInput}°C/min`;
          break;
        }

        case 'Patamar': {
          const tp = parseFloat(document.getElementById('temp_pat').value)||0;
          const tm = parseFloat(document.getElementById('tempo_pat').value)||0;
          tempo=tm; temperatura=tp;
          resumo = `${tp}°C por ${tm} min`;
          break;
        }
        case 'Transbordo': {
          const rb  = parseFloat(document.getElementById('rt_val').value)||0;
          const ti  = parseFloat(document.getElementById('ti').value)||0;
          const tf  = parseFloat(document.getElementById('tf').value)||0;
          const ttr = parseFloat(document.getElementById('tempo_tr').value)||0;
          tempo=ttr; temperatura=tf;
          resumo = `1:${rb}, ${ti}→${tf}°C, ${ttr} min`;
          break;
        }
        case 'Soltar Banho':
          tempo=3; temperatura=0;
          resumo='Soltar Banho';
          break;
        case 'Aviso': {
          const av = document.getElementById('aviso').value;
          const ph = document.getElementById('faixa_ph')?.value;
          tempo=5; temperatura= lastStepTemp();
          resumo = ph?`${av} (pH ${ph})`:av;
          break;
        }
      }
      const dados = { resumo, tempo, temperatura };
      await fetch('/adicionar_etapa',{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({ tipo, dados })
      });
      fecharModal();
      location.reload();
    }

    function gerarGrafico() {
      const img = document.getElementById('grafico');
      img.src = '/grafico.png?' + Date.now();
      img.style.display = 'block';
    }

    async function editarEtapa() {
      if (selectedIndex===null) return alert('Selecione uma etapa.');
      abrirModal();
      const et = etapasData[selectedIndex];
      document.getElementById('tipo').value = et.tipo;
      mostrarCamposEtapa();
      Object.entries(et.dados).forEach(([k,v])=>{
        // mapear chaves para IDs de input
        const map = {
          'Sequência do Produto':'sequencia',
          'Tempo de Dosagem':'tempo_dos',
          'Curva de Dosagem':'curva_dos',
          'Água':'agua',
          'Água de Injeção':'agua_inj',
          'Relação de Banho':'relacao',
          'Temp. atual':'temp_atual',
          'Temp. final':'temp_final',
          'Gradiente':'gradiente',
          'Temperatura':'temp_pat',
          'Tempo':'tempo_pat',
          'Relação':'rt_val',
          'Temp. Inicial':'ti',
          'Temp. Final':'tf',
          'Tempo':'tempo_tr',
          'Aviso':'aviso',
          'Faixa de pH':'faixa_ph'
        };
        const el = document.getElementById(map[k]||k);
        if (el) el.value = v;
      });
    }

    async function excluirEtapa() { if(selectedIndex===null) return alert('Selecione.'); await fetch(`/excluir_etapa/${selectedIndex}`,{method:'POST'}); location.reload(); }
    async function subirEtapa()    { if(selectedIndex===null) return alert('Selecione.'); await fetch(`/subir_etapa/${selectedIndex}`,{method:'POST'}); location.reload(); }
    async function descerEtapa()   { if(selectedIndex===null) return alert('Selecione.'); await fetch(`/descer_etapa/${selectedIndex}`,{method:'POST'}); location.reload(); }
    async function limparEtapas()  { if(!confirm('Remover todas?')) return; await fetch('/limpar_etapas',{method:'POST'}); location.reload(); }
    async function editarTitulo()  { const n=prompt('Novo título:','{{ titulo }}'); if(n!=null){ await fetch('/atualizar_titulo',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({titulo:n})}); location.reload(); } }
    function salvarEtapas()        { window.location = '/salvar_dados'; }
    function carregarEtapas()      { fileInput.click(); }
    async function uploadDados(evt){ const f=evt.target.files[0]; if(!f) return; const fd=new FormData(); fd.append('file',f); const r=await fetch('/carregar_dados',{method:'POST',body:fd}); const j=await r.json(); if(j.success) location.reload(); else alert('Erro:'+j.error); }
    async function imprimir(c)    { const r=await fetch('/imprimir_pdf',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({com_custo:c})}); const b=await r.blob(); window.open(URL.createObjectURL(b)); }
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>{{ titulo }}</title>
  <style>
    body { font-family: Tahoma, sans-serif; background-color: #e8ecf0; margin: 0; padding: 20px; }
    .container { background-color: #f4f4f4; padding: 15px 25px; border-radius: 5px; max-width: 1000px; margin: auto; box-shadow: 0 0 8px rgba(0,0,0,0.1); }
    h2 { font-size: 20px; margin-bottom: 10px; }
    button { background-color: #ececec; border: 1px solid #999; padding: 6px 12px; font-size: 13px; margin: 3px 2px; cursor: pointer; }
    button:hover { background-color: #ddd; }
    table { width: 100%; border-collapse: collapse; background-color: white; margin-top: 10px; }
    th, td { border: 1px solid #aaa; padding: 6px; text-align: center; }
    th { background-color: #dce6f2; font-weight: bold; }
    p { margin-top: 20px; font-weight: bold; text-align: center; }
    tr.selected { background-color: #fff2a8; }
    #grafico-container { position: relative; display: inline-block; }
    #grafico-total { position: absolute; top: 5px; right: 5px; background: rgba(255,255,255,0.8); padding: 4px 8px; border: 1px solid #999; font-size: 12px; }
    #modal, #modal-receita { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); justify-content: center; align-items: center; }
    #modal-content, #modal-receita-content { background: white; padding: 20px; border-radius: 8px; min-width: 400px; max-height: 90%; overflow-y: auto; }
    #modal select, #modal input, #modal-receita input, #modal-receita select { margin-bottom: 10px; width: 100%; padding: 6px; }
    #tabela-receita { width: 100%; border-collapse: collapse; margin-bottom: 10px; }
  </style>
</head>
<body>
  <div class="container">
    <img src="{{ url_for('static', filename='logo_hanier.png') }}" alt="Logo Hanier" style="float:right; width:160px; margin-top:-10px; margin-right:10px;">
    <h2>{{ titulo }}</h2>
    <div style="margin-bottom:15px;">
      <button id="btnNova">Nova Etapa</button>
      <button id="btnEditar">Editar Etapa</button>
      <button id="btnExcluir">Excluir Etapa</button>
      <button id="btnSubir">↑ Subir</button>
      <button id="btnDescer">↓ Descer</button>
      <button id="btnLimpar">Limpar</button>
      <button id="btnTitulo">Editar Título</button>
      <button id="btnSalvar">Salvar Etapas</button>
      <button id="btnCarregar">Carregar Etapas</button>
      <button id="btnImprimir">Imprimir</button>
      <button id="btnReceita">Receita</button>
      <button id="btnGrafico">Gerar Gráfico</button>
    </div>

    <table id="tabela-etapas">
      <tr><th>Tipo de Etapa</th><th>Resumo</th><th>Tempo (min)</th></tr>
      {% for etapa in etapas %}
      <tr data-index="{{ loop.index0 }}"><td>{{ etapa.tipo }}</td><td>{{ etapa.dados.resumo }}</td><td>{{ etapa.dados.tempo }}</td></tr>
      {% endfor %}
    </table>

    <p>Tempo total: {{ tempo_total }}</p>
    <div id="grafico-container">
      <img id="grafico" src="" style="display:none; width:800px; margin-top:10px;" alt="Gráfico de Tingimento">
      <div id="grafico-total">Tempo total: {{ tempo_total }}</div>
    </div>
  </div>

  <!-- Modal de Etapa -->
  <div id="modal">
    <div id="modal-content">
      <h3>Nova/Edita Etapa</h3>
      <label>Tipo de Etapa:</label>
      <select id="tipo"></select>
      <div id="campos-etapa"></div>
      <button id="btnConfirmar">Confirmar</button>
      <button id="btnFechar">Cancelar</button>
    </div>
  </div>

  <!-- Modal de Receita -->
  <div id="modal-receita">
    <div id="modal-receita-content">
      <h3>Receita</h3>
      <table id="tabela-receita">
        <tr><th>Produto</th><th>Sequência</th><th>Preço (R$)</th><th>Quantidade</th><th>% / g/L</th><th>R$/kg</th></tr>
      </table>
      <label>Produto:</label><input id="rec-prod" type="text">
      <label>Sequência:</label><input id="rec-seq" type="text">
      <label>Preço (R$):</label><input id="rec-preco" type="number" step="0.01">
      <label>Quantidade:</label><input id="rec-qt" type="number">
      <label>% / g/L:</label><select id="rec-unid"><option>%</option><option>g/L</option></select>
      <button id="btnAddRec">Adicionar</button>
      <button id="btnEditRec">Editar</button>
      <button id="btnDelRec">Excluir</button>
      <button id="btnCloseRec">Fechar</button>
    </div>
  </div>

  <input type="file" id="fileInput" accept=".json" style="display:none">

  <script>
    const etapasData = {{ etapas_json | safe }};
    let selectedIndex = null;

    document.addEventListener('DOMContentLoaded', () => {
      const map = {
        Nova: abrirModal, Editar: editarEtapa, Excluir: excluirEtapa,
        Subir: subirEtapa, Descer: descerEtapa, Limpar: limparEtapas,
        Titulo: editarTitulo, Salvar: salvarEtapas, Carregar: carregarEtapas,
        Imprimir: () => imprimir(false), Receita: abrirReceita, Grafico: gerarGrafico
      };
      Object.keys(map).forEach(k => {
        document.getElementById('btn'+k).onclick = map[k];
      });
      document.getElementById('btnCloseRec').onclick = () => modalReceita.style.display = 'none';
      document.getElementById('fileInput').onchange = uploadDados;
      document.getElementById('btnConfirmar').onclick = confirmarEtapa;
      document.getElementById('btnFechar').onclick = fecharModal;
      document.getElementById('tipo').onchange = mostrarCamposEtapa;
      document.querySelectorAll('#tabela-etapas tr[data-index]').forEach(tr => tr.onclick = selecionarLinha);
    });

    function selecionarLinha(evt) {
      document.querySelectorAll('tr.selected').forEach(r=>r.classList.remove('selected'));
      const tr = evt.currentTarget; tr.classList.add('selected');
      selectedIndex = parseInt(tr.dataset.index);
    }

    function abrirModal() {
      const tipos = ['Encher Máquina','Injetar Produto','Dosagem de Produto','Termoregulação','Patamar','Transbordo','Soltar Banho','Aviso'];
      const sel = document.getElementById('tipo'); sel.innerHTML = tipos.map(t=>`<option>${t}</option>`).join('');
      document.getElementById('modal').style.display='flex'; mostrarCamposEtapa();
    }

    function fecharModal() { document.getElementById('modal').style.display='none'; }

    function mostrarCamposEtapa() {
      const tipo = document.getElementById('tipo').value;
      let html = '';
      switch(tipo) {
        case 'Encher Máquina':
          html = `<label>Água:</label><select id="agua"><option>Quente</option><option>Fria</option></select>
                  <label>Relação de Banho (1:x):</label><input id="relacao" type="number">`;
          break;
        case 'Injetar Produto':
          html = `<label>Produto:</label><input id="produto" type="text">
                  <label>Água:</label><select id="agua_inj"><option>Limpa</option><option>Retorno</option></select>`;
          break;
        case 'Dosagem de Produto':
          html = `<label>Sequência:</label><input id="seq_prod" type="text">
                  <label>Tempo de Dosagem (min):</label><input id="tempo_dos" type="number">
                  <label>Curva (opcional):</label><input id="curva_dos" type="text">`;
          break;
        case 'Termoregulação':
          html = `<label>Temp. atual (°C):</label><input id="temp_atual" type="number">
                  <label>Temp. final (°C):</label><input id="temp_final" type="number">
                  <label>Gradiente (°C/min):</label><input id="gradiente" type="number">`;
          break;
        case 'Patamar':
          html = `<label>Temperatura (°C):</label><input id="temp_pat" type="number">
                  <label>Tempo (min):</label><input id="tempo_pat" type="number">`;
          break;
        case 'Transbordo':
          html = `<label>Relação (1:x):</label><input id="rt_val" type="number">
                  <label>Temp. Inicial (°C):</label><input id="ti" type="number">
                  <label>Temp. Final (°C):</label><input id="tf" type="number">
                  <label>Tempo (min):</label><input id="tempo_tr" type="number">`;
          break;
        case 'Soltar Banho':
          html = '<p><strong>Soltar Banho</strong></p>';
          break;
        case 'Aviso':
          html = `<label>Aviso:</label><select id="aviso"><option>Amostra</option><option>Medir Densidade</option><option>Medir pH</option></select>
                  <div id="ph-campos"></div>`;
          break;
      }
      document.getElementById('campos-etapa').innerHTML = html;
      const aviso = document.getElementById('aviso');
      if(aviso) aviso.onchange = e=>{
        document.getElementById('ph-campos').innerHTML = e.target.value==='Medir pH'?
          '<label>Faixa de pH:</label><input id="faixa_ph" type="text">':'';
      };
    }

    function lastStepTemp() {
      if(!etapasData.length) return 0;
      const t = etapasData[etapasData.length-1].dados.temperatura;
      return typeof t==='number'?t:parseFloat(t)||0;
    }

    async function confirmarEtapa() {
      const tipo = document.getElementById('tipo').value;
      let tempo=0, temperatura=0, resumo='';
      switch(tipo) {
        case 'Encher Máquina': {
          tempo=3; temperatura=document.getElementById('agua').value==='Quente'?40:25;
          resumo=`Água ${document.getElementById('agua').value}, 1:${document.getElementById('relacao').value}`;
          break;
        }
        case 'Injetar Produto': {
          tempo=2; temperatura=lastStepTemp();
          resumo=`${document.getElementById('produto').value}, água ${document.getElementById('agua_inj').value}`;
          break;
        }
        case 'Dosagem de Produto': {
          const seq = document.getElementById('seq_prod').value;
          const dur = parseFloat(document.getElementById('tempo_dos').value)||0;
          tempo=dur; temperatura=lastStepTemp();
          resumo=`Seq ${seq}, Dosagem: ${dur} min${document.getElementById('curva_dos').value?`, curva ${document.getElementById('curva_dos').value}`:''}`;
          break;
        }
        case 'Termoregulação': {
          const t0=parseFloat(document.getElementById('temp_atual').value)||0;
          const t1=parseFloat(document.getElementById('temp_final').value)||0;
          const g=parseFloat(document.getElementById('gradiente').value);
          const gradUse = g||5;
          tempo=Math.abs(t1-t0)/gradUse; temperatura=t1;
          resumo=`${t1>t0?'Aquecer':'Resfriar'} de ${t0}→${t1}°C, ${g}°C/min`;
          break;
        }
        case 'Patamar': {
          const tp=parseFloat(document.getElementById('temp_pat').value)||0;
          const tm=parseFloat(document.getElementById('tempo_pat').value)||0;
          tempo=tm; temperatura=tp;
          resumo=`${tp}°C por ${tm} min`;
          break;
        }
        case 'Transbordo': {
          const rb=parseFloat(document.getElementById('rt_val').value)||0;
          const ti=parseFloat(document.getElementById('ti').value)||0;
          const tf=parseFloat(document.getElementById('tf').value)||0;
          const ttr=parseFloat(document.getElementById('tempo_tr').value)||0;
          tempo=ttr; temperatura=tf;
          resumo=`1:${rb}, ${ti}→${tf}°C, ${ttr} min`;
          break;
        }
        case 'Soltar Banho': {
          tempo=3; temperatura=lastStepTemp(); resumo='Soltar Banho'; break;
        }
        case 'Aviso': {
          const av=document.getElementById('aviso').value;
          const ph=document.getElementById('faixa_ph')?.value;
          tempo=5; temperatura=lastStepTemp();
          resumo=ph?`${av} (pH ${ph})`:av; break;
        }
      }
      const dados={resumo, tempo, temperatura};
      await fetch('/adicionar_etapa',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({tipo,dados})});
      fecharModal(); location.reload();
    }

    function gerarGrafico(){
      const img=document.getElementById('grafico');
      img.src='/grafico.png?'+Date.now(); img.style.display='block';
    }

    async function editarEtapa(){
      if(selectedIndex===null)return alert('Selecione uma etapa.');
      const et=etapasData[selectedIndex]; abrirModal(); document.getElementById('tipo').value=et.tipo; mostrarCamposEtapa();
      Object.entries(et.dados).forEach(([k,v])=>{ try{ document.getElementById({
        'Água':'agua','Relação de Banho':'relacao','produto':'produto','Água de Injeção':'agua_inj',
        'Sequência':'seq_prod','Tempo de Dosagem':'tempo_dos','Curva de Dosagem':'curva_dos',
        'Temp. atual':'temp_atual','Temp. final':'temp_final','Gradiente':'gradiente',
        'Temperatura':'temp_pat','Tempo':'tempo_pat','Relação':'rt_val','Temp. Inicial':'ti',
        'Temp. Final':'tf','Tempo':'tempo_tr','Aviso':'aviso','Faixa de pH':'faixa_ph'
      }[k]||k).value=v;}catch{} });
    }
    async function excluirEtapa(){if(selectedIndex===null)return alert('Selecione uma etapa.');await fetch(`/excluir_etapa/${selectedIndex}`,{method:'POST'});location.reload();}
    async function subirEtapa(){if(selectedIndex===null)return alert('Selecione uma etapa.');await fetch(`/subir_etapa/${selectedIndex}`,{method:'POST'});location.reload();}
    async function descerEtapa(){if(selectedIndex===null)return alert('Selecione uma etapa.');await fetch(`/descer_etapa/${selectedIndex}`,{method:'POST'});location.reload();}
    async function limparEtapas(){if(!confirm('Remover todas as etapas?'))return;await fetch('/limpar_etapas',{method:'POST'});location.reload();}
    async function editarTitulo(){const n=prompt('Novo título:', '{{ titulo }}');if(n!=null){await fetch('/atualizar_titulo',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({titulo:n})});location.reload();}}
    function salvarEtapas(){window.location='/salvar_dados';}
    function carregarEtapas(){document.getElementById('fileInput').click();}
    async function uploadDados(evt){const f=evt.target.files[0];if(!f)return;const fd=new FormData();fd.append('file',f);const r=await fetch('/carregar_dados',{method:'POST',body:fd});const j=await r.json();if(j.success)location.reload();else alert('Erro:'+j.error);}
    async function imprimir(c){const r=await fetch('/imprimir_pdf',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({com_custo:c})});const b=await r.blob();window.open(URL.createObjectURL(b));}

    function abrirReceita(){document.getElementById('modal-receita').style.display='flex'; initializeReceita(); }
    function initializeReceita(){/* lógica de UI de receita: limpar tabela, preencher eventos de adicionar/editar/excluir */}
  </script>
</body>
</html>
<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>{{ titulo }}</title>
  <style>
    body { font-family: Tahoma, sans-serif; background-color: #e8ecf0; margin: 0; padding: 20px; }
    .container { background-color: #f4f4f4; padding: 15px 25px; border-radius: 5px; max-width: 1000px; margin: auto; box-shadow: 0 0 8px rgba(0,0,0,0.1); }
    h2 { font-size: 20px; margin-bottom: 10px; }
    button { background-color: #ececec; border: 1px solid #999; padding: 6px 12px; font-size: 13px; margin: 3px 2px; cursor: pointer; }
    button:hover { background-color: #ddd; }
    table { width: 100%; border-collapse: collapse; background-color: white; margin-top: 10px; }
    th, td { border: 1px solid #aaa; padding: 6px; text-align: center; }
    th { background-color: #dce6f2; font-weight: bold; }
    p { margin-top: 20px; font-weight: bold; text-align: center; }
    tr.selected { background-color: #fff2a8; }
    #modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); justify-content: center; align-items: center; }
    #modal-content { background: white; padding: 20px; border-radius: 8px; min-width: 400px; }
    #modal select, #modal input { margin-bottom: 10px; width: 100%; padding: 6px; }
  </style>
</head>
<body>
  <div class="container">
    <img src="{{ url_for('static', filename='logo_hanier.png') }}" alt="Logo Hanier"
         style="float: right; width: 160px; margin-top: -10px; margin-right: 10px;">
    <h2>{{ titulo }}</h2>
    <div style="margin-bottom: 15px;">
      <button id="btnNova">Nova Etapa</button>
      <button id="btnEditar">Editar Etapa</button>
      <button id="btnExcluir">Excluir Etapa</button>
      <button id="btnSubir">↑ Subir</button>
      <button id="btnDescer">↓ Descer</button>
      <button id="btnLimpar">Limpar</button>
      <button id="btnTitulo">Editar Título</button>
      <button id="btnSalvar">Salvar Etapas</button>
      <button id="btnCarregar">Carregar Etapas</button>
      <button id="btnImprimir">Imprimir</button>
      <button id="btnReceita">Receita</button>
    </div>

    <table id="tabela-etapas">
      <tr><th>Tipo de Etapa</th><th>Resumo</th><th>Tempo (min)</th></tr>
      {% for etapa in etapas %}
      <tr data-index="{{ loop.index0 }}">
        <td>{{ etapa.tipo }}</td>
        <td>{{ etapa.dados.resumo }}</td>
        <td>{{ etapa.dados.tempo }}</td>
      </tr>
      {% endfor %}
    </table>

    <p>Tempo total: {{ tempo_total }}</p>
    <h3>Gráfico de Temperatura × Tempo</h3>
    <button id="btnGrafico">Gerar Gráfico</button>
    <img id="grafico" src="" style="display:none; width:800px; margin-top:10px;" alt="Gráfico de Tingimento">
  </div>

  <div id="modal">
    <div id="modal-content">
      <h3>Nova Etapa</h3>
      <label>Tipo de Etapa:</label>
      <select id="tipo"></select>
      <div id="campos-etapa"></div>
      <button id="btnConfirmar">Confirmar</button>
      <button id="btnFechar">Cancelar</button>
    </div>
  </div>

  <input type="file" id="fileInput" accept=".json" style="display:none">

  <script>
    // Elementos
    const btnNova = document.getElementById('btnNova');
    const btnGrafico = document.getElementById('btnGrafico');
    const tabela = document.getElementById('tabela-etapas');
    const modal = document.getElementById('modal');
    const tipoSelect = document.getElementById('tipo');
    const camposEtapa = document.getElementById('campos-etapa');
    const btnConfirmar = document.getElementById('btnConfirmar');
    const btnFechar = document.getElementById('btnFechar');
    const imgGrafico = document.getElementById('grafico');
    const fileInput = document.getElementById('fileInput');

    const etapasData = {{ etapas_json | safe }};
    let selectedIndex = null;

    // Eventos
    btnNova.onclick = abrirModal;
    btnGrafico.onclick = gerarGrafico;
    btnFechar.onclick = fecharModal;
    btnConfirmar.onclick = confirmarEtapa;
    document.getElementById('btnEditar').onclick = editarEtapa;
    document.getElementById('btnExcluir').onclick = excluirEtapa;
    document.getElementById('btnSubir').onclick = subirEtapa;
    document.getElementById('btnDescer').onclick = descerEtapa;
    document.getElementById('btnLimpar').onclick = limparEtapas;
    document.getElementById('btnTitulo').onclick = editarTitulo;
    document.getElementById('btnSalvar').onclick = salvarEtapas;
    document.getElementById('btnCarregar').onclick = carregarEtapas;
    document.getElementById('btnImprimir').onclick = () => imprimir(false);
    document.getElementById('btnReceita').onclick = () => imprimir(true);
    tipoSelect.onchange = mostrarCamposEtapa;
    document.querySelectorAll('#tabela-etapas tr[data-index]').forEach(tr => tr.onclick = selecionarLinha);

    function selecionarLinha(event) {
      tabela.querySelectorAll('tr.selected').forEach(r => r.classList.remove('selected'));
      const tr = event.currentTarget;
      tr.classList.add('selected');
      selectedIndex = parseInt(tr.dataset.index);
    }

    function abrirModal() {
      const tipos = ['Encher Máquina','Injetar Produto','Dosagem de Produto','Termoregulação','Patamar','Transbordo','Soltar Banho','Aviso'];
      tipoSelect.innerHTML = tipos.map(t => `<option value="${t}">${t}</option>`).join('');
      modal.style.display = 'flex';
      mostrarCamposEtapa();
    }

    function fecharModal() {
      modal.style.display = 'none';
    }

    function mostrarCamposEtapa() {
      const tipo = tipoSelect.value;
      let html = '';
      if (tipo === 'Encher Máquina') {
        html = `
          <label>Água:</label>
          <select id="agua"><option>Quente</option><option>Fria</option></select>
          <label>Relação de Banho (1:x):</label>
          <input id="relacao" type="number" placeholder="Ex: 10">
        `;
      } else if (tipo === 'Injetar Produto') {
        html = `
          <label>Produto:</label>
          <input id="produto" type="text" placeholder="Nome do produto">
          <label>Água:</label>
          <select id="agua_inj"><option>Limpa</option><option>Retorno</option></select>
        `;
      } else if (tipo === 'Dosagem de Produto') {
        html = `
          <label>Tempo de Dosagem (min):</label>
          <input id="tempo_dos" type="number" placeholder="Ex: 5">
          <label>Curva (opcional):</label>
          <input id="curva_dos" type="text" placeholder="Ex: rampa">
        `;
      } else if (tipo === 'Termoregulação') {
        html = `
          <label>Temp. atual (°C):</label><input id="temp_atual" type="number">
          <label>Temp. final (°C):</label><input id="temp_final" type="number">
          <label>Gradiente (°C/min):</label><input id="gradiente" type="number" placeholder="Ex: 3">
        `;
      } else if (tipo === 'Patamar') {
        html = `
          <label>Temperatura (°C):</label><input id="temp_pat" type="number">
          <label>Tempo (min):</label><input id="tempo_pat" type="number">
        `;
      } else if (tipo === 'Transbordo') {
        html = `
          <label>Relação (1:x):</label><input id="rt_val" type="number">
          <label>Temp. Inicial (°C):</label><input id="ti" type="number">
          <label>Temp. Final (°C):</label><input id="tf" type="number">
          <label>Tempo (min):</label><input id="tempo_tr" type="number">
        `;
      } else if (tipo === 'Soltar Banho') {
        html = '<p>Resfriamento automático em 3 min</p>';
      } else if (tipo === 'Aviso') {
        html = `
          <label>Aviso:</label>
          <select id="aviso"><option>Amostra</option><option>Medir Densidade</option><option>Medir pH</option></select>
          <div id="ph-campos"></div>
        `;
      }
      camposEtapa.innerHTML = html;
      const aviso = document.getElementById('aviso');
      if (aviso) aviso.onchange = e => {
        document.getElementById('ph-campos').innerHTML = e.target.value==='Medir pH'
          ? '<label>Faixa de pH:</label><input id="faixa_ph" type="text">' : '';
      };
    }

    async function confirmarEtapa() {
      const tipo = tipoSelect.value;
      let tempo = 0, temperatura = 0, resumo = '';
      if (tipo === 'Encher Máquina') {
        const agua = document.getElementById('agua').value;
        const rel = document.getElementById('relacao').value;
        tempo = 3;
        temperatura = agua==='Quente'?40:25;
        resumo = `Água ${agua}, 1:${rel}`;
      } else if (tipo === 'Injetar Produto') {
        const prod = document.getElementById('produto').value;
        const aguaInj = document.getElementById('agua_inj').value;
        tempo = 2;
        temperatura = lastStepTemp();
        resumo = `${prod}, água ${aguaInj}`;
      } else if (tipo === 'Dosagem de Produto') {
        const td = parseFloat(document.getElementById('tempo_dos').value)||0;
        const curva = document.getElementById('curva_dos').value;
        tempo = td;
        temperatura = lastStepTemp();
        resumo = `Dosagem: ${td} min${curva?`, curva ${curva}`:''}`;
      } else if (tipo === 'Termoregulação') {
        const t0 = parseFloat(document.getElementById('temp_atual').value)||0;
        const t1 = parseFloat(document.getElementById('temp_final').value)||0;
        const g = parseFloat(document.getElementById('gradiente').value)||5;
        tempo = Math.abs(t1-t0)/g;
        temperatura = t1;
        resumo = `${t1>t0?'Aquecer':'Resfriar'} de ${t0}→${t1}°C, ${g}°C/min`;
      } else if (tipo === 'Patamar') {
        const tp = parseFloat(document.getElementById('temp_pat').value)||0;
        const tm = parseFloat(document.getElementById('tempo_pat').value)||0;
        tempo = tm; temperatura = tp;
        resumo = `${tp}°C por ${tm} min`;
      } else if (tipo === 'Transbordo') {
        const rb = parseFloat(document.getElementById('rt_val').value)||0;
        const ti = parseFloat(document.getElementById('ti').value)||0;
        const tf = parseFloat(document.getElementById('tf').value)||0;
        const ttr = parseFloat(document.getElementById('tempo_tr').value)||0;
        tempo = ttr; temperatura = tf;
        resumo = `1:${rb}, ${ti}→${tf}°C, ${ttr} min`;
      } else if (tipo==='Soltar Banho') {
        tempo=3; temperatura=0; resumo='Resfriamento automático';
      } else if (tipo==='Aviso') {
        const av=document.getElementById('aviso').value;
        const ph=document.getElementById('faixa_ph')?.value;
        tempo=5; resumo=ph?`${av} (pH ${ph})`:av; temperatura=lastStepTemp();
      }
      const dados={ resumo, tempo, temperatura };
      await fetch('/adicionar_etapa',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({tipo,dados})});
      fecharModal(); location.reload();
    }

    function lastStepTemp() {
      if (!etapasData || etapasData.length===0) return 0;
      const last = etapasData[etapasData.length-1];
      const t = last.dados && last.dados.temperatura;
      return typeof t==='number'?t:(parseFloat(t)||0);
    }

    function gerarGrafico() {
      imgGrafico.src = '/grafico.png?'+Date.now();
      imgGrafico.style.display='block';
    }

    async function editarEtapa() {
      if (selectedIndex===null) return alert('Selecione uma etapa.');
      // abrir modal e preencher campos de edição com etapasData[selectedIndex]
      abrirModal();
      tipoSelect.value = etapasData[selectedIndex].tipo;
      mostrarCamposEtapa();
      // aqui preencha cada input com valores de etapasData[selectedIndex].dados
    }

    async function excluirEtapa() {
      if (selectedIndex===null) return alert('Selecione uma etapa.');
      await fetch(`/excluir_etapa/${selectedIndex}`,{method:'POST'});
      location.reload();
    }

    async function subirEtapa() {
      if (selectedIndex===null) return alert('Selecione uma etapa.');
      await fetch(`/subir_etapa/${selectedIndex}`,{method:'POST'});
      location.reload();
    }

    async function descerEtapa() {
      if (selectedIndex===null) return alert('Selecione uma etapa.');
      await fetch(`/descer_etapa/${selectedIndex}`,{method:'POST'});
      location.reload();
    }

    async function limparEtapas() {
      if (!confirm('Remover todas as etapas?')) return;
      await fetch('/limpar_etapas',{method:'POST'});
      location.reload();
    }

    async function editarTitulo() {
      const n = prompt('Novo título:', '{{ titulo }}');
      if (n!=null) {
        await fetch('/atualizar_titulo',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({titulo:n})});
        location.reload();
      }
    }

    function salvarEtapas() { window.location='/salvar_dados'; }
    function carregarEtapas() { fileInput.click(); }

    async function uploadDados(evt) {
      const f = evt.target.files[0]; if(!f) return;
      const fd = new FormData(); fd.append('file',f);
      const r = await fetch('/carregar_dados',{method:'POST',body:fd});
      const j = await r.json();
      if(j.success) location.reload(); else alert('Erro:'+j.error);
    }

    async function imprimir(comCusto) {
      const r = await fetch('/imprimir_pdf',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({com_custo:comCusto})});
      const b = await r.blob(); window.open(URL.createObjectURL(b));
    }

  </script>
</body>
</html>